<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>This page is down</title>
	<link href="styles.css" rel="stylesheet" type="text/css">
	<script src="main.js"></script>
</head>
<body>
<div class="container">

	<div id="header">
	<h1>Stats Unavailable</h1>
		</div>
	<div id="content">
		<p>This page temporarily hit the GitHub API rate limit. The data should return soon.</p>

		<div id="countdown">Hopefully it should be available soonâ€¦</div>

		<div id="report-container">
			<button id="report-button">Report this to the admin</button>
		</div>
	</div>

	<script>
		// Function to send a secure report
	  function updateCountdown() {
	    const now = new Date();
	    const nextHour = new Date(Date.UTC(
	      now.getUTCFullYear(),
	      now.getUTCMonth(),
	      now.getUTCDate(),
	      now.getUTCHours() + 1,
	      0, 0
	    ));

	    const diff = nextHour - now;
	    const minutes = String(Math.floor((diff / 1000 / 60) % 60)).padStart(2, "0");
	    const seconds = String(Math.floor((diff / 1000) % 60)).padStart(2, "0");

	    document.getElementById("countdown").textContent =
			    `Hopefully it should be available in ${minutes}:${seconds}, thank you for your patience.`;

		// Redirect logic
		const params = new URLSearchParams(window.location.search);
		const allowedPages = {
			"contributors": "contributors.html",
			"stats": "stats.html"
		}; // Whitelist of allowed pages with corresponding URLs
		let from = params.get("from");
		const redirectUrl = allowedPages[from] || allowedPages["stats"]; // Default to "stats" if invalid

	    // Auto-retry at UTC hour
	    if (minutes === "00" && seconds === "00") {
	      const tokenRes = fetch("https://proxy.spacexplorer11.hackclub.app/get-token");
        const {token, timestamp} = tokenRes.json();

    fetch(`https://proxy.spacexplorer11.hackclub.app/stats?token=${token}&timestamp=${timestamp}`)
	        .then(res => res.ok && window.location.replace(redirectUrl))
	        .catch(() => {});
	    }
	  }

	  setInterval(updateCountdown, 1000);
	  updateCountdown();

	  // Manual report button logic
	  const button = document.getElementById("report-button");
	  const container = document.getElementById("report-container");

	  const now = new Date();
	  const currentUtcHour = `${now.getUTCFullYear()}-${now.getUTCMonth()}-${now.getUTCDate()}-${now.getUTCHours()}`;
	  const storageKey = "last-report-time";

	  if (localStorage.getItem(storageKey) === currentUtcHour) {
	    container.innerHTML = "<p>Already reported. Thank you!</p>";
	  }

	  button?.addEventListener("click", async () => {
	    try {
	      localStorage.setItem(storageKey, currentUtcHour);
	      container.innerHTML = "<p>Reported! Thank you for helping.</p>";

	      await sendSecureReport("user");

	    } catch (err) {
	      container.innerHTML = "<p>Something went wrong, but we tried.</p>";
	      console.error("Webhook failed", err);
	    }
	  });

	  window.addEventListener("DOMContentLoaded", () =>  {
		if (areStatsAvailable()) {
			// Redirect logic
			const params = new URLSearchParams(window.location.search);
			const allowedPages = {
				"contributors": "contributors.html",
				"stats": "stats.html"
			}; // Whitelist of allowed pages with corresponding URLs
			let from = params.get("from");
			const redirectUrl = allowedPages[from] || allowedPages["contributors"]; // Default to "stats" if invalid
			if (from in allowedPages) {
				window.location.replace(redirectUrl)
			}
			else {
				window.location.replace("index.html");
			}
		}
	  });
	</script>
</div>
{% include footer.html %}
</body>
</html>
